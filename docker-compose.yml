services:
    db:
        image: mysql:8.0
        platform: linux/arm64
        environment:
            MYSQL_DATABASE: balance
            MYSQL_USER: balance
            MYSQL_PASSWORD: balance
            MYSQL_ROOT_PASSWORD: root
        ports:
            - "3306:3306"
        volumes:
            - db_data:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-proot"]
            interval: 5s
            timeout: 5s
            retries: 30

    backend:
        build:
            context: ./backend
        environment:
            APP_ENV: local
            APP_DEBUG: "true"
            APP_URL: http://localhost:8080

            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: "3306"
            DB_DATABASE: balance
            DB_USERNAME: balance
            DB_PASSWORD: balance

            SANCTUM_STATEFUL_DOMAINS: localhost,localhost:3000,localhost:8080,127.0.0.1,127.0.0.1:8080,::1
            SESSION_DOMAIN: localhost
            SESSION_SECURE_COOKIE: "false"
            SESSION_SAME_SITE: lax
        volumes:
            - ./backend:/var/www/html
        depends_on:
            db:
                condition: service_healthy

    nginx:
        image: nginx:1.27-alpine
        ports:
            - "8080:80"
        volumes:
            - ./backend:/var/www/html:ro
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
        depends_on:
            - backend

    frontend:
        build:
            context: ./frontend
        environment:
            NODE_ENV: development
            CHOKIDAR_USEPOLLING: "true"
            NEXT_PUBLIC_API_URL: http://localhost:8080
        ports:
            - "3000:3000"
        volumes:
            - ./frontend:/app
            - /app/node_modules
        depends_on:
            - nginx

volumes:
    db_data:
